{% extends 'base.html' %}
{% block title %}Chatbot{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Chatbot</h2>
    <div id="chatbox" class="border p-3" style="height: 300px; overflow-y: scroll; background-color: rgba(255, 255, 255, 0.447);">
        <ul id="messages" class="list-unstyled">
            <!-- Chat messages will be appended here dynamically -->
        </ul>
    </div>
    <form id="chat-form" method="post">
        <div class="input-group mt-3">
            <input type="text" id="message-input" name="message" class="form-control" placeholder="Type your message..." autocomplete="off">
            <button type="submit" class="btn btn-primary">Send</button>
        </div>
    </form>
</div>
<br/>
<br/>
<br/>
<br/>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('chat-form');
        const input = document.getElementById('message-input');
        const messages = document.getElementById('messages');
        const chatbox = document.getElementById('chatbox');

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const userMessage = input.value;
            
            if (userMessage.trim() === '') return;

            // Display user's message
            const userMessageElement = document.createElement('li');
            userMessageElement.textContent = 'You: ' + userMessage;
            messages.appendChild(userMessageElement);

            // Scroll to the bottom of the chatbox
            chatbox.scrollTop = chatbox.scrollHeight;

            fetch('/chatbot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'message': userMessage
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json(); // Try to parse the response as JSON
            })
            .then(data => {
                const botMessageElement = document.createElement('li');
                botMessageElement.textContent = 'Bot: ' + data.response;
                messages.appendChild(botMessageElement);
            
                chatbox.scrollTop = chatbox.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                const errorMessageElement = document.createElement('li');
                errorMessageElement.textContent = 'Error: ' + error.message;
                messages.appendChild(errorMessageElement);
            });
        });
    });
</script>
{% endblock %}
